name: Build and Deploy
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Install Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Install SASS
      run: npm install -g sass

    - name: Compile SCSS to CSS
      run: sass src/Styles/scss:src/Styles

    - name: Build
      run: npm run build

    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build
        path: build/

    - name: Set custom message bad
      run: |
        if [ "${{ github.actor }}" = "IvanGudyushkin" ]; then
          echo "CUSTOM_MESSAGE_BAD=üí© @Ivanandreevichgud, –∏–¥–∏ —É–±–∏—Ä–∞–π –∫–∞–∫–∞—Ö–∏!" >> $GITHUB_ENV
        fi
        if [ "${{ github.actor }}" = "AlexUner" ]; then
          echo "CUSTOM_MESSAGE_BAD=üí© @AlexUner, –∏–¥–∏ —É–±–∏—Ä–∞–π –∫–∞–∫–∞—Ö–∏!" >> $GITHUB_ENV
        fi

    - name: Set custom message good
      run: |
        if [ "${{ github.actor }}" = "IvanGudyushkin" ]; then
          echo "CUSTOM_MESSAGE_GOOD=üèÜ @Ivanandreevichgud, –º–æ–ª–æ–¥–µ—Ü!" >> $GITHUB_ENV
        fi
        if [ "${{ github.actor }}" = "AlexUner" ]; then
          echo "CUSTOM_MESSAGE_GOOD=üèÜ @AlexUner, –º–æ–ª–æ–¥–µ—Ü!" >> $GITHUB_ENV
        fi

    - name: Send Telegram Notification on Failure build
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üö® 1/2. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞!
          ${{ env.CUSTOM_MESSAGE_BAD }}
          ‚ÄºÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
          *Ô∏è‚É£ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–¥–µ—Å—å: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Send Telegram Notification on Success build
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ‚úÖ 1/2. –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
          ${{ env.CUSTOM_MESSAGE_GOOD }}
          *Ô∏è‚É£ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–¥–µ—Å—å: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Download build artifacts
      uses: actions/download-artifact@v2
      with:
        name: build

    - name: Install lftp for SFTP
      run: sudo apt-get install lftp

    - name: SFTP Deploy
      run: |
        lftp -e "
        set ssl:verify-certificate no;
        set sftp:auto-confirm yes;
        set net:socket-buffer 524288;
        open sftp://devilaks@devilaks.ftp.tools;
        user ${{ secrets.SFTP_USERNAME }} ${{ secrets.SFTP_PASSWORD }};
        lcd ./build;

        mirror --reverse --continue --verbose --parallel=10 . /home/devilaks/anastasiyashakti.com/godovoy-astroprognoz;

        bye;
        "

    - name: Clear MODX Cache
      run: curl https://godovoy-astroprognoz.anastasiyashakti.com/clear-cache-script.php?key=${{ secrets.CACHE_SECRET_KEY }}

    - name: Set custom message bad
      run: |
        if [ "${{ github.actor }}" = "IvanGudyushkin" ]; then
          echo "CUSTOM_MESSAGE_BAD=üí© @Ivanandreevichgud, –∏–¥–∏ —É–±–∏—Ä–∞–π –∫–∞–∫–∞—Ö–∏!" >> $GITHUB_ENV
        fi
        if [ "${{ github.actor }}" = "AlexUner" ]; then
          echo "CUSTOM_MESSAGE_BAD=üí© @AlexUner, –∏–¥–∏ —É–±–∏—Ä–∞–π –∫–∞–∫–∞—Ö–∏!" >> $GITHUB_ENV
        fi

    - name: Set custom message good
      run: |
        if [ "${{ github.actor }}" = "IvanGudyushkin" ]; then
          echo "CUSTOM_MESSAGE_GOOD=üèÜ @Ivanandreevichgud, –º–æ–ª–æ–¥–µ—Ü!" >> $GITHUB_ENV
        fi
        if [ "${{ github.actor }}" = "AlexUner" ]; then
          echo "CUSTOM_MESSAGE_GOOD=üèÜ @AlexUner, –º–æ–ª–æ–¥–µ—Ü!" >> $GITHUB_ENV
        fi

    - name: Send Telegram Notification on Deploy Success
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üö® 2/2. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å!
          ${{ env.CUSTOM_MESSAGE_BAD }}
          ‚ÄºÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
          *Ô∏è‚É£ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–¥–µ—Å—å: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Send Telegram Notification on Deploy Success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üöÄ 2/2. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
          ${{ env.CUSTOM_MESSAGE_GOOD }}
          *Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://anastasiyashakti.com
